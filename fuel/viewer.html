<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STFD Fuel Entries Viewer</title>
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .details-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-container.expanded {
            max-height: 1000px; /* Adjust as needed */
        }
        .rotate-180 {
            transform: rotate(180deg);
        }
        
        @media screen {
            #print-container {
                display: none;
            }
        }

        @media print {
            body > *:not(#print-container) {
                display: none !important;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .print-entry {
                page-break-inside: avoid;
                margin-top: 20px;
            }
             .print-entry:first-child {
                margin-top: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Fuel Entries Viewer</h1>
        </header>

        <main class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col sm:flex-row items-center gap-4 w-full sm:w-auto">
                    <div class="relative w-full sm:w-auto">
                        <input type="text" id="searchInput" placeholder="Search entries..." class="w-full p-3 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
                    </div>
                    <select id="monthFilter" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow bg-white">
                        <option value="">All Months</option>
                        <option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option>
                    </select>
                    <select id="yearFilter" class="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow bg-white">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                     <p id="entryCount" class="text-gray-600 font-medium whitespace-nowrap"></p>
                     <button id="generateReportBtn" disabled class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">Report (0)</button>
                     <button id="exportCsvBtn" disabled class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">Export CSV (0)</button>
                </div>
            </div>
             <div class="flex items-center p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                <div class="w-16 flex-shrink-0 text-center"><input type="checkbox" id="selectAllCheckbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></div>
                <div class="grid grid-cols-3 gap-4 w-full text-left text-xs font-bold text-gray-500 uppercase tracking-wider">
                    <div class="pl-2">Date</div><div>Apparatus</div><div>Purchaser</div>
                </div>
                <div class="w-10 flex-shrink-0"></div>
            </div>
            <div id="data-container" class="divide-y divide-gray-200">
                <div id="loadingState" class="text-center p-10"><div class="flex justify-center items-center gap-4"><div class="loader"></div><span class="text-gray-500">Fetching data...</span></div></div>
                <div id="errorState" class="hidden text-center p-10"><p class="text-red-500 font-semibold">Could not fetch data.</p><p class="text-gray-500">Please check your connection and configuration.</p></div>
                <div id="noResultsState" class="hidden text-center p-10"><p class="text-gray-500 font-semibold">No entries found matching your criteria.</p></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-50"><div class="relative"><img id="modalImage" src="" class="max-w-full max-h-screen rounded-lg shadow-xl"><span id="closeModal" class="absolute -top-4 -right-4 text-white bg-gray-800 rounded-full h-10 w-10 flex items-center justify-center text-2xl font-bold cursor-pointer hover:bg-gray-600">&times;</span></div></div>
    <div id="reportModalContainer" class="fixed inset-0 bg-gray-800 bg-opacity-75 hidden items-center justify-center p-4 z-50"><div class="bg-white rounded-lg shadow-2xl p-8 max-w-4xl w-full max-h-full overflow-y-auto"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Report Preview</h2><div class="flex items-center gap-4"><button id="printButton" class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600">Print</button><span id="closeReportModal" class="text-gray-500 hover:text-gray-800 text-3xl cursor-pointer">&times;</span></div></div><div id="reportContent"></div></div></div>
    
    <!-- Hidden container for printing -->
    <div id="print-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA-4zB5WLhdpb6yhKEy6SZ2I5FS-ipgIBY",
            authDomain: "stfd-fuel-form.firebaseapp.com",
            projectId: "stfd-fuel-form",
            storageBucket: "stfd-fuel-form.firebasestorage.app",
            messagingSenderId: "420570035631",
            appId: "1:420570035631:web:5da57666c0d49d02d7eb5a",
            measurementId: "G-VMRETXFSZB"
        };
        
        let allData = [];
        let selectedEntries = new Set();

        const dataContainer = document.getElementById('data-container');
        const searchInput = document.getElementById('searchInput');
        const monthFilter = document.getElementById('monthFilter');
        const yearFilter = document.getElementById('yearFilter');
        const entryCount = document.getElementById('entryCount');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const noResultsState = document.getElementById('noResultsState');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        
        async function fetchData() {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const collectionRef = collection(db, `artifacts/${firebaseConfig.appId}/public/data/fuel_entries`);
                const q = query(collectionRef, orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);

                allData = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Map Firebase fields to the keys the script expects
                    return {
                        id: doc.id,
                        date: data.date,
                        apparatus: data.apparatus,
                        purchaser: data.purchaser,
                        odometer: data.odometer,
                        gallonsPurchased: data.gallons,
                        fuelAmount: data['fuel-amount'],
                        pricePerGallon: data['price-per-gallon'],
                        otherItemsAmount: data['other-items-amount'],
                        otherItems: data['other-items'],
                        reasonForOtherItems: data['reason-other-items'],
                        receipt: data.receiptUrl // Mapped from receiptUrl
                    };
                });
                
                populateYearFilter();
                displayData(allData);
                
                loadingState.style.display = 'none';
                if (allData.length === 0) noResultsState.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching from Firestore:', error);
                loadingState.style.display = 'none';
                errorState.classList.remove('hidden');
            }
        }
        
        function populateYearFilter() {
            const years = [...new Set(allData.map(entry => {
                if (!entry.date) return null;
                return new Date(entry.date).getFullYear();
            }).filter(Boolean))];
            years.sort((a, b) => b - a);
            yearFilter.innerHTML = '<option value="">All Years</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
        }

        function displayData(data) {
            dataContainer.innerHTML = ''; 
            if (data.length === 0) {
                noResultsState.classList.remove('hidden');
            } else {
                noResultsState.classList.add('hidden');
            }

            data.forEach(entry => {
                const entryWrapper = document.createElement('div');
                const formattedDate = entry.date ? `${entry.date.substring(5, 7)}-${entry.date.substring(8, 10)}-${entry.date.substring(0, 4)}` : 'N/A';
                
                let receiptContent = '<p class="text-sm text-gray-500">No Receipt</p>';
                if (entry.receipt && entry.receipt.startsWith('http')) {
                    receiptContent = `
                        <div class="w-40 h-24 bg-gray-200 rounded-md shadow-sm cursor-pointer hover:scale-105 transition-transform duration-200 overflow-hidden" 
                             onclick="event.stopPropagation(); showImageModal('${entry.receipt}')">
                            <img src="${entry.receipt}" alt="Receipt Thumbnail" class="w-full h-full object-cover">
                        </div>`;
                }

                entryWrapper.innerHTML = `
                    <div class="summary-row flex items-center p-4 hover:bg-gray-50 cursor-pointer">
                        <div class="w-16 flex-shrink-0 text-center">
                            <input type="checkbox" class="row-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" data-id="${entry.id}" ${selectedEntries.has(entry.id) ? 'checked' : ''}>
                        </div>
                        <div class="grid grid-cols-3 gap-4 w-full text-sm text-gray-800">
                            <div class="font-medium text-gray-900 pl-2">${formattedDate}</div>
                            <div>${entry.apparatus || 'N/A'}</div>
                            <div>${entry.purchaser || 'N/A'}</div>
                        </div>
                        <div class="w-10 flex-shrink-0 text-center expand-icon">
                            <svg class="w-5 h-5 text-gray-400 transition-transform duration-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                        </div>
                    </div>
                    <div class="details-container bg-gray-50">
                        <div class="p-6">
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-4 text-sm">
                                <div class="p-2"><strong class="font-semibold text-gray-600 block">Odometer:</strong> ${entry.odometer || 'N/A'}</div>
                                <div class="p-2"><strong class="font-semibold text-gray-600 block">Gallons Purchased:</strong> ${entry.gallonsPurchased || 'N/A'}</div>
                                <div class="p-2"><strong class="font-semibold text-gray-600 block">Fuel Amount:</strong> ${formatAsCurrency(entry.fuelAmount)}</div>
                                <div class="p-2"><strong class="font-semibold text-gray-600 block">Price per Gallon:</strong> ${formatAsCurrency(entry.pricePerGallon, true)}</div>
                                <div class="p-2"><strong class="font-semibold text-gray-600 block">Other Items Amount:</strong> ${formatAsCurrency(entry.otherItemsAmount)}</div>
                                <div class="p-2 sm:col-span-2 md:col-span-3"><strong class="font-semibold text-gray-600 block">Other Items:</strong> ${entry.otherItems || 'N/A'}</div>
                                <div class="p-2 sm:col-span-2 md:col-span-3"><strong class="font-semibold text-gray-600 block">Reason for Other Items:</strong> ${entry.reasonForOtherItems || 'N/A'}</div>
                                <div>
                                    <strong class="font-semibold text-gray-600 block mb-2">Receipt:</strong>
                                    ${receiptContent}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                dataContainer.appendChild(entryWrapper);
            });
            updateEntryCount(data.length);
            updateActionButtons();
        }

        function formatAsCurrency(value, isPricePerGallon = false) {
            if (value === null || value === undefined || String(value).trim() === '' || isNaN(Number(value))) {
                return '$0.00';
            }
            const number = parseFloat(value);
            const options = { style: 'currency', currency: 'USD' };
            if (isPricePerGallon) {
                options.minimumFractionDigits = 3;
                options.maximumFractionDigits = 3;
            }
            return number.toLocaleString('en-US', options);
        }

        window.showImageModal = (url) => {
            document.getElementById('modalImage').src = url;
            document.getElementById('imageModal').classList.remove('hidden');
            document.getElementById('imageModal').classList.add('flex');
        }

        function applyFilters() {
            const query = searchInput.value.toLowerCase();
            const month = monthFilter.value;
            const year = yearFilter.value;

            const filtered = allData.filter(entry => {
                const entryDate = entry.date ? new Date(entry.date) : null;
                const matchesSearch = query === '' || Object.values(entry).some(val => String(val).toLowerCase().includes(query));
                const matchesMonth = month === '' || (entryDate && entryDate.getMonth() == month);
                const matchesYear = year === '' || (entryDate && entryDate.getFullYear() == year);
                return matchesSearch && matchesMonth && matchesYear;
            });
            displayData(filtered);
        }

        function updateEntryCount(count) {
            entryCount.textContent = `Showing ${count} of ${allData.length}`;
        }

        function updateActionButtons() {
            const count = selectedEntries.size;
            generateReportBtn.textContent = `Report (${count})`;
            generateReportBtn.disabled = count === 0;
            exportCsvBtn.textContent = `Export CSV (${count})`;
            exportCsvBtn.disabled = count === 0;
        }

        function generateReport() {
            const selectedData = allData.filter(entry => selectedEntries.has(entry.id));
            let reportHTML = `<div class="report-header text-center mb-4"><h3 class="text-2xl font-bold">Fuel & Item Purchase Report</h3><p class="text-sm text-gray-500">Generated on: ${new Date().toLocaleString()}</p></div>`;
            
            selectedData.forEach(entry => {
                const formattedDate = entry.date ? `${entry.date.substring(5, 7)}-${entry.date.substring(8, 10)}-${entry.date.substring(0, 4)}` : 'N/A';
                reportHTML += `
                    <div class="print-entry border-t pt-4 mt-4">
                        <table class="w-full text-sm border-collapse mb-4">
                            <tbody>
                                <tr><td class="font-semibold p-2 bg-gray-100 border w-1/3">Date:</td><td class="p-2 border">${formattedDate}</td></tr>
                                <tr><td class="font-semibold p-2 bg-gray-100 border w-1/3">Apparatus:</td><td class="p-2 border">${entry.apparatus || 'N/A'}</td></tr>
                                <tr><td class="font-semibold p-2 bg-gray-100 border w-1/3">Purchaser:</td><td class="p-2 border">${entry.purchaser || 'N/A'}</td></tr>
                                ${entry.apparatus !== 'Other Items' ? `
                                <tr><td class="font-semibold p-2 bg-gray-100 border">Odometer:</td><td class="p-2 border">${entry.odometer || 'N/A'}</td></tr>
                                <tr><td class="font-semibold p-2 bg-gray-100 border">Fuel Amount:</td><td class="p-2 border">${formatAsCurrency(entry.fuelAmount)}</td></tr>` : ''}
                                ${entry.otherItems ? `<tr><td class="font-semibold p-2 bg-gray-100 border">Other Items Amount:</td><td class="p-2 border">${formatAsCurrency(entry.otherItemsAmount)}</td></tr>` : ''}
                            </tbody>
                        </table>
                        ${entry.receipt ? `<div class="text-center"><img src="${entry.receipt}" class="max-w-full max-h-96 mx-auto"></div>` : ''}
                    </div>
                `;
            });
            document.getElementById('reportContent').innerHTML = reportHTML;
            document.getElementById('print-container').innerHTML = reportHTML;
            document.getElementById('reportModalContainer').classList.remove('hidden');
            document.getElementById('reportModalContainer').classList.add('flex');
        }

        function exportCSV() {
            const selectedData = allData.filter(entry => selectedEntries.has(entry.id));
            if (selectedData.length === 0) {
                alert("No entries selected for export.");
                return;
            }

            // Sort the data by date before exporting
            selectedData.sort((a, b) => new Date(a.date) - new Date(b.date));

            const headers = [
                "Date", "Apparatus", "Odometer", "Gallons Purchased", 
                "Fuel Amount", "Price per Gallon", "Other Items Amount", "Other Items", 
                "Reason for Other Items", "Purchaser", "Receipt URL"
            ];
            
            const escapeCsvCell = (cell) => {
                if (cell === null || cell === undefined) return '';
                const cellStr = String(cell);
                if (/[",\n\r]/.test(cellStr)) {
                    return `"${cellStr.replace(/"/g, '""')}"`;
                }
                return cellStr;
            };
            
            const csvRows = [headers.join(',')];

            selectedData.forEach(entry => {
                const row = [
                    entry.date, entry.apparatus, entry.odometer,
                    entry.gallonsPurchased, entry.fuelAmount, entry.pricePerGallon,
                    entry.otherItemsAmount, entry.otherItems, entry.reasonForOtherItems,
                    entry.purchaser, entry.receipt
                ].map(escapeCsvCell);
                csvRows.push(row.join(','));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            const now = new Date();
            const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            link.setAttribute("download", `fuel_entries_export_${dateStr}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Event Listeners
        searchInput.addEventListener('input', applyFilters);
        monthFilter.addEventListener('change', applyFilters);
        yearFilter.addEventListener('change', applyFilters);
        
        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const visibleCheckboxes = dataContainer.querySelectorAll('.row-checkbox');
            visibleCheckboxes.forEach(cb => {
                cb.checked = isChecked;
                const id = cb.dataset.id;
                if (isChecked) selectedEntries.add(id);
                else selectedEntries.delete(id);
            });
            updateActionButtons();
        });

        dataContainer.addEventListener('click', e => {
            if (e.target.classList.contains('row-checkbox')) {
                const id = e.target.dataset.id;
                if (e.target.checked) {
                    selectedEntries.add(id);
                } else {
                    selectedEntries.delete(id);
                }
                updateActionButtons();
            } 
            else if (e.target.closest('.summary-row')) {
                const wrapper = e.target.closest('.summary-row').parentElement;
                wrapper.querySelector('.details-container').classList.toggle('expanded');
                wrapper.querySelector('.expand-icon svg').classList.toggle('rotate-180');
            }
        });
        
        generateReportBtn.addEventListener('click', generateReport);
        exportCsvBtn.addEventListener('click', exportCSV);
        document.getElementById('closeModal').addEventListener('click', () => document.getElementById('imageModal').classList.add('hidden'));
        document.getElementById('reportModalContainer').addEventListener('click', (e) => {
            if(e.target.id === 'reportModalContainer' || e.target.id === 'closeReportModal') {
                 document.getElementById('reportModalContainer').classList.add('hidden');
            }
        });
        document.getElementById('printButton').addEventListener('click', () => window.print());

        fetchData();
    </script>
</body>
</html>




