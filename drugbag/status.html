<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for table header to be sticky */
        thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Exchange Log</h1>
                <p class="text-gray-600 mt-1">Showing the most recent exchanges first.</p>
            </div>
            <a href="./index.html" class="mt-4 sm:mt-0 inline-block bg-blue-600 text-white font-medium px-5 py-2.5 rounded-lg shadow hover:bg-blue-700 transition">
                New Exchange Form
            </a>
        </div>

        <div id="status-container">
            <div class="bg-white p-8 rounded-2xl shadow-lg">
                <p class="text-center text-gray-500">Loading exchange data...</p>
            </div>
        </div>
    </div>

    <script>
        const statusContainer = document.getElementById('status-container');
        const dataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLWQ6ur2EG7GjueVIE-kzBGTyNutoiiiKt9oyM0wNm7ko44JZFrwFzjjSx2XOCa39RqGXX7i3ayQwI/pub?gid=46850043&single=true&output=csv';

        /**
         * Parses a single row of CSV text, properly handling commas within quoted fields.
         * @param {string} text The raw text of a single CSV row.
         * @returns {string[]} An array of strings representing the cells in the row.
         */
        function parseCsvRow(text) {
            const result = [];
            let current = '';
            let inQuote = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') {
                    inQuote = !inQuote;
                } else if (char === ',' && !inQuote) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }


        async function loadStatus() {
            try {
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const csvText = await response.text();
                const rows = csvText.trim().split('\n');
                
                if (rows.length <= 1) {
                     statusContainer.innerHTML = `
                        <div class="bg-white p-8 rounded-2xl shadow-lg">
                            <p class="text-center text-gray-500">No exchange data found.</p>
                        </div>`;
                    return;
                }
                
                const headers = parseCsvRow(rows[0]);
                const data = rows.slice(1).map(row => {
                    return parseCsvRow(row);
                }).reverse(); // Show newest first

                let tableHtml = `
                    <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                    <tr>
                                        ${headers.map(header => `<th scope="col" class="px-6 py-3">${header.replace(/"/g, '')}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                `;

                data.forEach(rowData => {
                    tableHtml += `<tr class="bg-white border-b hover:bg-gray-50">`;
                    
                    // Take only as many cells as there are headers to prevent extra columns from breaking the layout.
                    let cellsToRender = rowData.slice(0, headers.length);

                    // Pad the row with empty cells if it's shorter than the headers.
                    while (cellsToRender.length < headers.length) {
                        cellsToRender.push('');
                    }

                    cellsToRender.forEach(cellData => {
                        // Use (cellData || '') for safety, then remove quotes for display.
                        tableHtml += `<td class="px-6 py-4">${(cellData || '').replace(/"/g, '')}</td>`;
                    });
                    tableHtml += `</tr>`;
                });

                tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                statusContainer.innerHTML = tableHtml;

            } catch (error) {
                console.error('Error fetching status data:', error);
                statusContainer.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                        <strong class="font-bold">Error!</strong>
                        <span class="block sm:inline">Could not load exchange data. Please try again later.</span>
                    </div>
                `;
            }
        }
        
        document.addEventListener('DOMContentLoaded', loadStatus);
    </script>
</body>
</html>

