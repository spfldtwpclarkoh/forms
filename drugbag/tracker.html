<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drug Bag Expiration Tracker</title>
    <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Drug Bag Expiration Dates</h1>
            <p class="text-md text-gray-600 mt-2">Tracking earliest expiration dates for drug bags.</p>
        </header>

        <!-- Legend for color coding -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-red-200 border border-red-400 mr-2"></div>
                <span class="text-sm">Expired or Expires within 10 days</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-yellow-200 border border-yellow-400 mr-2"></div>
                <span class="text-sm">Expires within 30 days</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 rounded-full bg-green-200 border border-green-400 mr-2"></div>
                <span class="text-sm">Expires in more than 30 days</span>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div id="loading" class="text-center p-8">
                <p class="text-gray-500">Loading data from Google Sheet...</p>
            </div>
            <div class="overflow-x-auto">
                <table id="expirations-table" class="min-w-full divide-y divide-gray-200 hidden">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Apparatus</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drug Bag #</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Earliest Expiration</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Data will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <footer class="text-center mt-8">
            <p class="text-sm text-gray-500">Created by TFrank615</p>
        </footer>
    </div>

    <script>
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQLWQ6ur2EG7GjueVIE-kzBGTyNutoiiiKt9oyM0wNm7ko44JZFrwFzjjSx2XOCa39RqGXX7i3ayQwI/pub?gid=0&single=true&output=csv';
        const table = document.getElementById('expirations-table');
        const tableBody = table.querySelector('tbody');
        const loadingDiv = document.getElementById('loading');

        /**
         * Parses CSV text into an array of objects.
         * @param {string} csvText The CSV text to parse.
         * @returns {Array<Object>} An array of objects representing the rows.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim());
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    rows.push(row);
                }
            }
            return rows;
        }
        
        /**
         * Determines the row color based on the expiration date.
         * @param {string} dateString The expiration date string (e.g., "MM/DD/YYYY").
         * @returns {string} Tailwind CSS class for the row background color.
         */
        function getRowColorClass(dateString) {
            if (!dateString) return 'bg-white';

            const expirationDate = new Date(dateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date

            // Check if the date is valid
            if (isNaN(expirationDate.getTime())) {
                return 'bg-gray-100'; // Invalid date format
            }

            const timeDiff = expirationDate.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

            if (daysDiff <= 10) {
                return 'bg-red-200'; // Expired or expires within 10 days
            } else if (daysDiff <= 30) {
                return 'bg-yellow-200'; // Expires within 30 days
            } else {
                return 'bg-green-200'; // Expires in more than 30 days
            }
        }


        /**
         * Fetches and displays the data from the Google Sheet.
         */
        async function loadSheetData() {
            try {
                const response = await fetch(sheetUrl);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const csvText = await response.text();
                const data = parseCSV(csvText);

                // Sort data by "Earliest Expiration" date, ascending
                data.sort((a, b) => {
                    const dateA = new Date(a['Earliest Expiration']);
                    const dateB = new Date(b['Earliest Expiration']);

                    // Handle cases with invalid dates by pushing them to the bottom
                    if (isNaN(dateA.getTime())) return 1;
                    if (isNaN(dateB.getTime())) return -1;
                    
                    return dateA - dateB;
                });
                
                // Clear any existing rows
                tableBody.innerHTML = '';

                // Populate the table
                data.forEach(rowData => {
                    const row = document.createElement('tr');
                    
                    const expirationDate = rowData['Earliest Expiration'];
                    row.className = getRowColorClass(expirationDate);

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rowData['Apparatus'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${rowData['Drug Bag #'] || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${expirationDate || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${rowData['Last Updated'] || ''}</td>
                    `;
                    tableBody.appendChild(row);
                });

                // Hide loading indicator and show table
                loadingDiv.classList.add('hidden');
                table.classList.remove('hidden');

            } catch (error) {
                console.error('Error fetching or parsing sheet data:', error);
                loadingDiv.innerHTML = '<p class="text-red-500">Failed to load data. Please check the link or your network connection.</p>';
            }
        }

        // Load the data when the page is ready
        document.addEventListener('DOMContentLoaded', loadSheetData);
    </script>
</body>
</html>

