<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Submissions - STFD</title>
    <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="./images/apple-touch-icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .submission-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 2rem;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        .submission-card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .card-header {
            background-color: #1f2937;
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* MODIFICATION: Allow buttons to wrap on small screens */
            gap: 0.5rem; /* MODIFICATION: Add spacing when wrapped */
        }
        .card-body {
            padding: 1.5rem;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.25rem 0;
        }
        .info-item .label {
            font-weight: 500;
            color: #4b5563;
            margin-right: 1rem;
        }
         .info-item .value {
            color: #1f2937;
            text-align: left; /* MODIFICATION: Better for wrapping text on mobile */
            word-break: break-word; /* MODIFICATION: Ensure long values without spaces can wrap */
        }
        @media (min-width: 640px) { /* sm breakpoint */
             .info-item .value {
                text-align: right; /* MODIFICATION: Revert to right-align on larger screens */
            }
        }
        .pdf-btn {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .pdf-btn:hover {
            background-color: #4338ca;
        }
        .pdf-btn:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .status-request {
            background-color: #fef9c3;
            color: #854d0e;
        }
        .status-completed {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-denied {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        .deny-btn {
            background-color: #dc2626; /* red-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            cursor: pointer;
            margin-left: 0.5rem; /* Add some space */
        }
        .deny-btn:hover {
            background-color: #b91c1c; /* red-700 */
        }

        /* Login Form Styles */
        #login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
        }
        .login-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 28rem;
        }
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px #bfdbfe;
        }
        .login-btn {
            width: 100%;
            background-color: #1f2937;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .login-btn:hover {
            background-color: #374151;
        }
        .login-btn:disabled {
            background-color: #9ca3af;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        .hidden {
            display: none !important;
        }

        /* --- PDF Template Styles --- */
        /* Positioned off-screen for reliable html2canvas capture */
        #pdf-template {
            position: absolute;
            left: -9999px;
            top: 0;
            display: block !important;
            width: 800px; /* A fixed width for consistent rendering */
            padding: 40px;
            background-color: white;
            color: #333;
            font-family: Arial, sans-serif;
            font-size: 12pt;
            line-height: 1.4;
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        #pdf-template h1 {
            font-size: 24pt;
            font-weight: bold;
            color: #1f2937;
            text-align: center;
            margin-bottom: 2rem;
        }
        #pdf-template h2 {
            font-size: 16pt;
            font-weight: bold;
            color: #1f2937;
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        #pdf-template .info-table,
        #pdf-template #pdf-installation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #pdf-template .info-table td,
        #pdf-template #pdf-installation-table td,
        #pdf-template #pdf-installation-table th {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            word-break: break-word; /* Handle long text */
        }
        #pdf-template .info-table td:first-child {
            font-weight: bold;
            width: 30%;
        }
        #pdf-template #pdf-installation-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        #pdf-template .checkbox {
            font-family: monospace; /* Ensures checkbox alignment */
            font-size: 14pt;
        }
        #pdf-template p {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        #pdf-template img {
            max-width: 100%;
            height: 40px; /* Keep consistent height */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <!-- Login Form -->
    <div id="login-container">
        <div class="login-card">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">STFD Submissions Login</h1>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" id="login-button" class="login-btn">Login</button>
                <p id="login-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <!-- Main Content (hidden by default) -->
    <div id="content-container" class="hidden">
        <div class="max-w-7xl mx-auto">
            <!-- MODIFICATION: Added padding-top for mobile, responsive button positioning, and responsive text size -->
            <header class="text-center mb-8 relative pt-16 md:pt-0">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Smoke Alarm Installation Submissions</h1>
                <p class="text-lg sm:text-xl text-gray-600">Springfield Township Fire Department</p>
                <button id="request-notify-btn" class="hidden absolute top-4 left-4 md:top-0 md:left-0 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition">
                    Enable Notifications
                </button>
                <button id="sign-out-btn" class="absolute top-4 right-4 md:top-0 md:right-0 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm transition">
                    Sign Out
                </button>
            </header>

            <main id="submissions-container">
                <p class="text-center text-gray-500">Loading submissions...</p>
            </main>
        </div>
    </div>

    <!-- This is the hidden template for the PDF -->
    <div id="pdf-template"> <!-- REMOVED class="hidden" -->
        <!-- PDF Template remains the same -->
        <h1>Smoke Alarm Installation</h1>
        
        <h2>Resident Information</h2>
        <table class="info-table">
            <tr><td>Name:</td><td id="pdf-residentName"></td></tr>
            <tr><td>Address:</td><td id="pdf-address"></td></tr>
            <tr><td>City/State/ZIP:</td><td id="pdf-cityStateZip"></td></tr>
            <tr><td>Phone Number:</td><td id="pdf-phone"></td></tr>
            <tr><td>Email (optional):</td><td id="pdf-email"></td></tr>
        </table>

        <h2>Property Information</h2>
        <table class="info-table">
            <tr>
                <td>Property Type:</td>
                <td>
                    <span id="pdf-prop-sfh" class="checkbox">☐</span> Single-Family Home &nbsp;&nbsp;
                    <span id="pdf-prop-apt" class="checkbox">☐</span> Apartment/Condo &nbsp;&nbsp;
                    <span id="pdf-prop-mob" class="checkbox">☐</span> Mobile Home
                </td>
            </tr>
            <tr><td>Number of Floors:</td><td id="pdf-numFloors"></td></tr>
            <tr><td>Number of Bedrooms:</td><td id="pdf-numBedrooms"></td></tr>
            <tr><td>Existing Alarms Before Visit?</td><td id="pdf-existingAlarms"></td></tr>
            <tr><td>Working Alarms Present?</td><td id="pdf-workingAlarms"></td></tr>
        </table>
        
        <h2>Installation Details</h2>
        <table id="pdf-installation-table">
            <thead>
                <tr><th>Room/Area</th><th>New Alarm Installed</th><th>Battery Checked</th><th>Alarm Tested</th><th>Notes</th></tr>
            </thead>
            <tbody id="pdf-installation-tbody"></tbody>
        </table>
        <p style="margin-top: 8px;"><strong>Number of Alarms Installed:</strong> <span id="pdf-alarmsInstalled"></span></p>

        <h2>Resident Acknowledgement & Waiver</h2>
        <p style="font-size: 10pt; margin-top: 0.5rem;">I acknowledge that the smoke alarms were installed or checked by representatives of the Springfield Township Fire Department. I understand it is my responsibility to test the alarms monthly and replace batteries as needed. The fire department is not responsible for the maintenance or future performance of these devices.</p>
        <p style="margin-top: 1rem;">
            <span id="pdf-receivedInfo" class="checkbox">☐</span> I have received fire safety information. &nbsp;&nbsp;
            <span id="pdf-givePermission" class="checkbox">☐</span> I give permission for installation and testing of alarms.
        </p>

        <table class="info-table" style="margin-top: 2rem;">
            <tr>
                <td>Resident Signature:</td>
                <td><img id="pdf-residentSig" style="height: 40px; display: none;"></td>
                <td>Date:</td>
                <td id="pdf-residentDate"></td>
            </tr>
            <tr>
                <td>Fire Dept. Installer Name:</td>
                <td id="pdf-installerName"></td>
            </tr>
            <tr>
                <td>Signature:</td>
                <td><img id="pdf-installerSig" style="height: 40px; display: none;"></td>
                <td>Date:</td>
                <td id="pdf-submissionDate"></td>
            </tr>
        </table>
    </div>

    <!-- Denial Reason Modal -->
    <div id="deny-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4"> <!-- MODIFICATION: Added p-4 for spacing on small screens -->
        <div class="login-card p-6"> <!-- Re-using login-card style -->
            <form id="deny-form">
                <h2 class="text-xl font-bold text-center text-gray-800 mb-4">Deny Request</h2>
                <div class="mb-4">
                    <label for="denial-reason" class="block text-sm font-medium text-gray-700 mb-1">Reason for Denial</label>
                    <textarea id="denial-reason" class="form-input" rows="4" required></textarea>
                </div>
                <p id="deny-error" class="error-message hidden"></p>
                <div class="flex justify-end space-x-2 mt-4">
                    <button type="button" id="cancel-deny-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg">Cancel</button>
                    <button type="submit" id="confirm-deny-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Confirm Denial</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, query, onSnapshot, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Import Firebase Auth modules
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            // Your existing config is here
            apiKey: "AIzaSyBlZP-8fKHBD32ZcRJbtZfrC8tw51XUVk8",
            authDomain: "stfd-smoke-detector-form.firebaseapp.com",
            projectId: "stfd-smoke-detector-form",
            storageBucket: "stfd-smoke-detector-form.firebasestorage.app",
            messagingSenderId: "1025681020503",
            appId: "1:1025681020503:web:f2c84c6134b2d5a3c13512",
            measurementId: "G-226TY8VVCK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // Initialize Auth

        const loginContainer = document.getElementById('login-container');
        const contentContainer = document.getElementById('content-container');
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const signOutBtn = document.getElementById('sign-out-btn');
        const submissionsContainer = document.getElementById('submissions-container');
        const notifyBtn = document.getElementById('request-notify-btn');
        
        // Denial Modal Elements
        const denyModal = document.getElementById('deny-modal');
        const denyForm = document.getElementById('deny-form');
        const denyError = document.getElementById('deny-error');
        const cancelDenyBtn = document.getElementById('cancel-deny-btn');
        const confirmDenyBtn = document.getElementById('confirm-deny-btn');
        const denialReasonText = document.getElementById('denial-reason');
        let docToDenyId = null; // Variable to hold the doc ID
        
        const { jsPDF } = window.jspdf;

        let firestoreUnsubscribe = null; // To hold the onSnapshot listener
        let isInitialLoad = true; // To prevent notifications on first load

        // --- Audio Notification Function ---
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A nice "ping"
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (err) {
                console.error("Could not play notification sound:", err);
            }
        }

        // --- Helper function to format dates ---
        function formatDate(dateInput) {
            if (!dateInput) return '';
            
            let date;
            // Check if it's a Firestore Timestamp
            if (dateInput && typeof dateInput.toDate === 'function') {
                date = dateInput.toDate();
            } 
            // Check if it's an ISO 8601 string (like from residentDate YYYY-MM-DD)
            else if (typeof dateInput === 'string' && dateInput.match(/^\d{4}-\d{2}-\d{2}$/)) {
                // Split to avoid timezone issues where new Date('YYYY-MM-DD') can be off by one day
                const [year, month, day] = dateInput.split('-').map(Number);
                date = new Date(year, month - 1, day);
            } 
            // Check if it's already a Date object
            else if (dateInput instanceof Date) {
                date = dateInput;
            } 
            // If it's a string but not ISO, or some other type, try to parse it
            else {
                try {
                    date = new Date(dateInput);
                    // Check if date is valid
                    if (isNaN(date.getTime())) {
                        console.warn("Invalid date input for formatting:", dateInput);
                        return dateInput; // return original string if invalid
                    }
                } catch (e) {
                    console.warn("Error parsing date input:", dateInput, e);
                    return dateInput; // return original string if error
                }
            }

            // Now format the valid Date object
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const year = date.getFullYear();
            
            return `${month}/${day}/${year}`;
        }

        // --- PDF Generation Function (IMPROVED) ---
        async function generatePdf(data) {
           // Populate the template with data
            document.getElementById('pdf-residentName').textContent = data.residentName || '';
            document.getElementById('pdf-address').textContent = data.address || '';
            document.getElementById('pdf-cityStateZip').textContent = data.cityStateZip || '';
            document.getElementById('pdf-phone').textContent = data.phone || '';
            document.getElementById('pdf-email').textContent = data.email || 'N/A';
            
            document.getElementById('pdf-prop-sfh').textContent = data.propertyType === 'Single-Family Home' ? '☑' : '☐';
            document.getElementById('pdf-prop-apt').textContent = data.propertyType === 'Apartment/Condo' ? '☑' : '☐';
            document.getElementById('pdf-prop-mob').textContent = data.propertyType === 'Mobile Home' ? '☑' : '☐';

            document.getElementById('pdf-numFloors').textContent = data.numFloors || '';
            document.getElementById('pdf-numBedrooms').textContent = data.numBedrooms || '';
            document.getElementById('pdf-existingAlarms').textContent = data.existingAlarms || '';
            document.getElementById('pdf-workingAlarms').textContent = data.workingAlarms || '';
            document.getElementById('pdf-alarmsInstalled').textContent = data.alarmsInstalled || '';
            
            const tbody = document.getElementById('pdf-installation-tbody');
            tbody.innerHTML = ''; // Clear previous data
            if (data.installationDetails && data.installationDetails.length > 0) {
                data.installationDetails.forEach(d => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${d.room || ''}</td>
                        <td>${d.newAlarmInstalled || ''}</td>
                        <td>${d.batteryChecked || ''}</td>
                        <td>${d.alarmTested || ''}</td>
                        <td>${d.notes || ''}</td>
                    `;
                });
            }

            document.getElementById('pdf-receivedInfo').textContent = data.receivedInfo ? '☑' : '☐';
            document.getElementById('pdf-givePermission').textContent = data.givePermission ? '☑' : '☐';
            
            document.getElementById('pdf-residentDate').textContent = formatDate(data.residentDate);
            document.getElementById('pdf-installerName').textContent = data.installerName || '';
            document.getElementById('pdf-submissionDate').textContent = formatDate(data.createdAt);

            // --- Improved Image Loading ---
            const residentSigImg = document.getElementById('pdf-residentSig');
            const installerSigImg = document.getElementById('pdf-installerSig');

            // Helper function to create an image loading promise
            const loadImage = (imgElement, src) => {
                return new Promise((resolve) => {
                    if (!src) {
                        imgElement.style.display = 'none';
                        resolve(); // Resolve immediately if no src
                        return;
                    }
                    imgElement.src = src;
                    imgElement.style.display = 'block';
                    imgElement.onload = () => resolve();
                    imgElement.onerror = () => {
                        console.error("Failed to load signature image.");
                        // We still resolve so PDF generation doesn't break,
                        // but the image will be missing/broken.
                        resolve(); 
                    };
                });
            };

            // Create promises for both images
            const residentSigPromise = loadImage(residentSigImg, data.residentSignature);
            const installerSigPromise = loadImage(installerSigImg, data.installerSignature);
            
            const template = document.getElementById('pdf-template');
            // template.classList.remove('hidden'); // <-- No longer needed

            try {
                // Wait for both images to finish loading (or failing)
                await Promise.all([residentSigPromise, installerSigPromise]);

                // Now that images are loaded, capture the canvas
                const canvas = await html2canvas(template, { 
                    scale: 3, // Increased scale for better quality
                    useCORS: true,
                    logging: false // Suppress console logs from html2canvas
                });

                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;

                // Calculate dimensions to fit within A4 page with margins
                const margin = 10; // 10mm margin
                let effectiveWidth = pdfWidth - (2 * margin);
                let effectiveHeight = effectiveWidth / ratio;

                // Check if height exceeds page height
                if (effectiveHeight > (pdfHeight - (2 * margin))) {
                    // If it does, recalculate based on height
                    effectiveHeight = pdfHeight - (2 * margin);
                    effectiveWidth = effectiveHeight * ratio;
                    pdf.addImage(imgData, 'PNG', (pdfWidth - effectiveWidth) / 2, margin, effectiveWidth, effectiveHeight);
                } else {
                    pdf.addImage(imgData, 'PNG', margin, margin, effectiveWidth, effectiveHeight);
                }
                
                const safeName = (data.residentName || 'resident').replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const date = data.residentDate || new Date().toISOString().split('T')[0];
                pdf.save(`STFD_Submission_${safeName}_${date}.pdf`);
                
            } catch(err) {
                console.error("Error generating PDF:", err);
            } finally {
                // template.classList.add('hidden'); // <-- No longer needed
                // Reset images
                residentSigImg.src = '';
                residentSigImg.style.display = 'none';
                installerSigImg.src = '';
                installerSigImg.style.display = 'none';
            }
        }

        // --- Function to load submissions ---
        function loadSubmissions() {
            submissionsContainer.innerHTML = '<p class="text-center text-gray-500">Loading submissions...</p>';
            
            // --- MODIFICATION: Removed orderBy() from the query ---
            // The orderBy("createdAt", "desc") requires a composite index in Firestore.
            // By removing it, we can fetch the data and sort it in JavaScript,
            // which fixes the mobile-only loading bug.
            const q = query(collection(db, "submissions"));

            // Store the listener so we can unsubscribe later
            firestoreUnsubscribe = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    submissionsContainer.innerHTML = '<p class="text-center text-gray-500">No submissions found.</p>';
                    return;
                }

                // --- Notification Logic ---
                // Process changes to check for new requests
                querySnapshot.docChanges().forEach((change) => {
                    // Only trigger for documents 'added' *after* the initial page load
                    if (change.type === 'added' && !isInitialLoad) {
                        const docData = change.doc.data();
                        // Only trigger if the new document is a 'request'
                        if (docData.status === 'request') {
                            console.log('New request added:', docData.residentName);
                            
                            // 1. Play audio cue
                            playNotificationSound();
                            
                            // 2. Show browser notification (if permission granted)
                            if (Notification.permission === 'granted') {
                                new Notification('New Smoke Alarm Request', {
                                    body: `From: ${docData.residentName}\nAddress: ${docData.address}`,
                                    icon: './images/favicon.ico' // Optional: uses your favicon
                                });
                            }
                        }
                    }
                });

                // --- Render Logic ---
                submissionsContainer.innerHTML = ''; 

                // --- MODIFICATION: Sort the results in JavaScript ---
                const docs = querySnapshot.docs;
                
                // --- MODIFICATION: Made sorting "defensive" ---
                // This handles cases where 'createdAt' might be missing or null in a document,
                // preventing the app from crashing.
                docs.sort((a, b) => {
                    const dateA = a.data().createdAt?.toDate() || new Date(0); // Use optional chaining and default
                    const dateB = b.data().createdAt?.toDate() || new Date(0); // Use optional chaining and default
                    return dateB - dateA; // Sort descending (newest first)
                });
                
                // --- MODIFICATION: Iterate over the sorted 'docs' array ---
                docs.forEach((doc) => {
                    const data = doc.data();
                    const cardWrapper = document.createElement('div');
                    
                    // --- MODIFICATION: Defensive date formatting ---
                    // Handles missing 'createdAt' fields without crashing.
                    const submissionDate = data.createdAt 
                        ? data.createdAt.toDate().toLocaleString() 
                        : 'Date not available';
                        
                    const isRequest = data.status === 'request';
                    
                    // Set status text and style
                    let statusText = 'Completed';
                    let statusClass = 'status-completed';
                    let denialReason = data.denialReason || '';
                    if (isRequest) {
                        statusText = 'New Request';
                        statusClass = 'status-request';
                    } else if (data.status === 'denied') {
                        statusText = 'Denied';
                        statusClass = 'status-denied';
                    }

                    cardWrapper.innerHTML = `
                        <div class="submission-card">
                            <div class="card-header">
                                <div class="flex-grow">
                                    <h2 class="text-xl font-bold">${data.residentName}</h2>
                                    <span class="text-sm text-gray-300">${submissionDate}</span>
                                </div>
                                ${isRequest ? '<button class="deny-btn">Deny</button>' : ''}
                                <button class="pdf-btn" ${isRequest || data.status === 'denied' ? 'disabled' : ''}>Generate PDF</button>
                            </div>
                            <div class="card-body">
                                <div class="info-item">
                                    <span class="label">Status:</span>
                                    <span class="value"><span class="status-badge ${statusClass}">${statusText}</span></span>
                                </div>
                                ${data.status === 'denied' ? `
                                <div class="info-item">
                                    <span class="label">Denial Reason:</span>
                                    <span class="value">${denialReason}</span>
                                </div>
                                ` : ''}
                                <div class="info-item"><span class="label">Address:</span><span class="value">${data.address}</span></div>
                                <div class="info-item"><span class="label">Installer:</span><span class="value">${data.installerName || 'N/A'}</span></div>
                                <div class="info-item"><span class="label">Alarms Installed:</span><span class="value">${data.alarmsInstalled || 'N/A'}</span></div>
                            </div>
                        </div>
                    `;
                    
                    const card = cardWrapper.firstElementChild;
                    
                    // If it's a new request, make the card clickable to open the full form
                    if(isRequest) {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => {
                            window.location.href = `index.html?id=${doc.id}`;
                        });

                        // Add listener for the new Deny button
                        const denyButton = card.querySelector('.deny-btn');
                        denyButton.addEventListener('click', (e) => {
                            e.stopPropagation(); // Stop click from bubbling to the card
                            showDenyModal(doc.id);
                        });
                    }
                    
                    submissionsContainer.appendChild(card);
                    
                    const pdfButton = card.querySelector('.pdf-btn');
                    if (!isRequest && data.status !== 'denied') {
                        pdfButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            pdfButton.textContent = 'Generating...';
                            pdfButton.disabled = true;
                            
                            generatePdf(data).finally(() => {
                               pdfButton.textContent = 'Generate PDF';
                               pdfButton.disabled = false;
                            });
                        });
                    }
                });
                
                // After the first snapshot is processed, set the flag to false
                isInitialLoad = false;
            }, (error) => { // <-- MODIFICATION: Added error handler
                console.error("Error loading submissions: ", error);
                submissionsContainer.innerHTML = `<p class="text-center text-red-500 font-medium">Failed to load submissions: ${error.message}</p>`;
            });
        }

        // --- Deny Modal Logic ---
        function showDenyModal(docId) {
            docToDenyId = docId;
            denialReasonText.value = '';
            denyError.classList.add('hidden');
            denyModal.classList.remove('hidden');
            denialReasonText.focus();
        }

        function hideDenyModal() {
            docToDenyId = null;
            denyModal.classList.add('hidden');
        }

        cancelDenyBtn.addEventListener('click', hideDenyModal);

        denyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const reason = denialReasonText.value.trim();
            if (!reason) {
                denyError.textContent = 'A reason is required.';
                denyError.classList.remove('hidden');
                return;
            }
            if (!docToDenyId) return;

            confirmDenyBtn.disabled = true;
            confirmDenyBtn.textContent = 'Denying...';
            denyError.classList.add('hidden');

            try {
                const docRef = doc(db, 'submissions', docToDenyId);
                await updateDoc(docRef, {
                    status: 'denied',
                    denialReason: reason
                });
                // onSnapshot will handle the UI update
                hideDenyModal();
            } catch (err) { // <-- FIX: Added opening brace {
                console.error("Error denying document:", err);
                denyError.textContent = 'Failed to deny. Please try again.';
                denyError.classList.remove('hidden');
            } finally { // <-- FIX: Added closing brace }
                confirmDenyBtn.disabled = false;
                confirmDenyBtn.textContent = 'Confirm Denial';
            }
        });

        // --- Auth State Change Listener ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                console.log("User is signed in:", user.email);
                loginContainer.classList.add('hidden');
                contentContainer.classList.remove('hidden');

                // Reset initial load flag on login
                isInitialLoad = true;
                
                // Check notification permission and show button if needed
                if (Notification.permission === 'default') {
                    notifyBtn.classList.remove('hidden');
                } else {
                    notifyBtn.classList.add('hidden');
                }

                loadSubmissions(); // Load data only when authenticated
            } else {
                // User is signed out
                console.log("User is signed out.");
                loginContainer.classList.remove('hidden');
                contentContainer.classList.add('hidden');
                notifyBtn.classList.add('hidden'); // Hide notify button on logout
                
                // Clear submissions
                submissionsContainer.innerHTML = '';
                
                // Unsubscribe from Firestore listener if it exists
                if (firestoreUnsubscribe) {
                    firestoreUnsubscribe();
                    firestoreUnsubscribe = null;
                }
            }
        });

        // --- Login Form Submit Event ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            loginError.classList.add('hidden');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Login failed:", error.code, error.message);
                if (error.code === 'auth/invalid-credential') {
                     loginError.textContent = 'Invalid email or password.';
                } else {
                     loginError.textContent = 'An error occurred. Please try again.';
                }
                loginError.classList.remove('hidden');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            }
        });

        // --- Sign Out Button Click Event ---
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Sign out failed:", error);
                alert("Failed to sign out. Please try again.");
            }
        });

        // --- Notification Permission Button Event ---
        notifyBtn.addEventListener('click', async () => {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted' || permission === 'denied') {
                    notifyBtn.classList.add('hidden');
                }
                console.log('Notification permission status:', permission);
            } catch (err) {
                console.error('Error requesting notification permission:', err);
            }
        });

    </script>
</body>
</html>